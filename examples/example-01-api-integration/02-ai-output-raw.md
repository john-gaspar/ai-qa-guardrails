# Raw AI Output (test cases)

| id | title | type | preconditions | steps | expected result | data | mocks/stubs | validation | observability | cleanup/idempotency notes |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| TC-01 | Create payment with card source | happy | Account exists with balance; valid auth token | POST `/accounts/<ID>/payments` with body `{ "amount": 120.50, "currency": "USD", "source": { "type": "card", "token": "<TOKEN_PLACEHOLDER>" }, "metadata": { "invoiceId": "inv-1001" } }` and header `Idempotency-Key: idem-1` | 201 with `amount`, `currency`, `source.type`, `metadata.invoiceId`; returns `confirmationCode`, `postedAt` | See steps | None; hit ledger | Status 201; body echoes request; has `confirmationCode`, `postedAt` | Capture ledger call success log/metric | Reuse idempotency key should not double charge (expect same result) |
| TC-02 | Invalid currency rejected | negative | Account exists | POST with currency `"ZZZ"` | 400 validation error | `currency: "ZZZ"` | None | Status 400; error message mentions currency | Log contains validation failure | No cleanup |
| TC-03 | Missing Idempotency-Key | negative | Account exists | POST without `Idempotency-Key` header | 400 validation error | Valid body | None | Status 400; error mentions idempotency key required | Log validation failure | No cleanup |
| TC-04 | Duplicate idempotency key | idempotency | Initial successful payment created | Repeat same POST with same `Idempotency-Key: idem-dup` | Second call returns 200/201 with same body (idempotent) | Same as first | Ledger stub not required | Status 201; body same as first | Logs show request deduped | Idempotent; no extra charges |
| TC-05 | Ledger unavailable | edge | Ledger dependency offline | POST valid request; simulate ledger timeout | 502 with `errorCode` for ledger issue | Valid body | Stub ledger to timeout | Status 502; error payload includes code | Trace shows ledger call failed | No state change |
